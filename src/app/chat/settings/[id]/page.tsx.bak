
'use client';

import { useParams, notFound, useRouter } from 'next/navigation';
import { type User as UserType } from '@/lib/types';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Button } from '@/components/ui/button';
import { ArrowLeft, FileText, Loader2, LogOut, Edit, Phone, Mail, Shield, BookUser, Clock } from 'lucide-react';
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetDescription, SheetFooter } from '@/components/ui/sheet';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { useState, useEffect } from 'react';
import { useFirestore } from '@/firebase/provider';
import { doc, getDoc, updateDoc } from 'firebase/firestore';
import { useToast } from '@/hooks/use-toast';
import { useUser } from '@/firebase/auth/use-user';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Separator } from '@/components/ui/separator';
import { format, isToday, isYesterday } from 'date-fns';
import Image from 'next/image';

export default function UserProfilePage() {
  const params = useParams() as { id: string };
  const router = useRouter();
  const firestore = useFirestore();
  const { toast } = useToast();
  const { user: currentUser, loading: userLoading } = useUser();

  const [user, setUser] = useState<UserType | null>(null);
  const [loading, setLoading] = useState(true);
  const [isSheetOpen, setIsSheetOpen] = useState(false);
  const [editedUser, setEditedUser] = useState<Partial<UserType>>({});
  
  const isOwnProfile = currentUser?.uid === params.id;

  useEffect(() => {
    if (!firestore || !params.id) return;

    const fetchUser = async () => {
      setLoading(true);
      const userRef = doc(firestore, 'users', params.id as string);
      const docSnap = await getDoc(userRef);

      if (docSnap.exists()) {
        const userData = { id: docSnap.id, ...docSnap.data() } as UserType;
        setUser(userData);
        setEditedUser(userData);
      } else {
        notFound();
      }
      setLoading(false);
    };

    fetchUser();
  }, [firestore, params.id]);

  const handleSave = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!firestore || !user) return;

    setLoading(true);
    const userRef = doc(firestore, 'users', user.id);
    try {
        await updateDoc(userRef, editedUser);
        setUser(prev => prev ? { ...prev, ...editedUser } : null);
        toast({ title: 'Profil mis à jour', description: 'Les informations ont été enregistrées.' });
    } catch(error) {
        console.error("Error updating profile:", error);
        toast({ variant: 'destructive', title: 'Erreur', description: 'Impossible de mettre à jour le profil.' });
    } finally {
        setIsSheetOpen(false);
        setLoading(false);
    }
  };

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement>) => {
    setEditedUser(prev => ({...prev, [e.target.id]: e.target.value}));
  }
  
  const handleClassChange = (value: string) => {
    setEditedUser({ ...editedUser, class: value });
  };

  const handleLogout = async () => {
    try {
        // Clear local session
        localStorage.removeItem('userId');
        localStorage.removeItem('deviceId');
        localStorage.removeItem('user');
        
        // Optionally, update online status in Firestore
        if (firestore && currentUser) {
            const userRef = doc(firestore, 'users', currentUser.uid);
            await updateDoc(userRef, { online: false, lastSeen: new Date() });
        }

        router.push('/login');
    } catch (error) {
        console.error("Error signing out: ", error);
        toast({ variant: 'destructive', title: 'Erreur', description: 'Impossible de se déconnecter.' });
    }
}
  const formatLastSeen = (timestamp: any) => {
    if (!timestamp) return "jamais";
    const date = timestamp.toDate();
    if (isToday(date)) {
      return `aujourd'hui à ${format(date, 'HH:mm')}`;
    }
    if (isYesterday(date)) {
      return `hier à ${format(date, 'HH:mm')}`;
    }
    return `le ${format(date, 'dd/MM/yyyy à HH:mm')}`;
  };

  if (loading || userLoading) {
    return <div className="flex h-screen w-full items-center justify-center bg-background"><Loader2 className="h-8 w-8 animate-spin text-primary" /></div>;
  }

  if (!user) {
    notFound();
    return null;
  }

  return (
    <div className="flex flex-col h-full bg-background">
      <header className="p-4 flex items-center justify-between">
        <Button variant="ghost" size="icon" onClick={() => router.back()} className="size-9">
          <ArrowLeft size={20} />
        </Button>
        {isOwnProfile && (
          <div className="flex gap-2">
            <Button variant="outline" size="sm" className="gap-2" onClick={() => setIsSheetOpen(true)}>
              <Edit size={16} /> Modifier
            </Button>
            <Button variant="destructive" size="sm" className="gap-2" onClick={handleLogout}>
              <LogOut size={16} /> Déconnexion
            </Button>
          </div>
        )}
      </header>

      <main className="flex-1 overflow-auto px-4 md:px-6 pb-8">
        <div className="max-w-2xl mx-auto">
          <div className="flex flex-col items-center text-center">
            <div className="relative mb-4">
              <Avatar className="w-28 h-28 md:w-32 md:h-32 border-4 border-background shadow-lg">
                <AvatarImage src={user.avatar} alt={user.name} />
                <AvatarFallback className="text-5xl">{user.name.substring(0, 2)}</AvatarFallback>
              </Avatar>
              {user.online && (
                <span className="absolute bottom-1 right-1 block h-5 w-5 rounded-full bg-green-500 ring-4 ring-background" title="En ligne" />
              )}
            </div>
            <h1 className="text-3xl md:text-4xl font-bold tracking-tight">{user.name}</h1>
            <p className="text-muted-foreground mt-1">{user.email}</p>
            {user.admin && (
                <div className="mt-2 inline-flex items-center gap-2 text-xs font-semibold text-primary bg-primary/10 px-2 py-1 rounded-full">
                    <Shield size={14}/>
                    <span>Administrateur</span>
                </div>
            )}
          </div>

          <Separator className="my-6" />

          <div className="grid gap-6">
            {(user.bio) && (
              <div className="flex items-start gap-4">
                <FileText className="w-5 h-5 mt-1 text-muted-foreground flex-shrink-0" />
                <div>
                  <h3 className="font-semibold">Biographie</h3>
                  <p className="text-muted-foreground text-sm mt-1">{user.bio}</p>
                </div>
              </div>
            )}

            {user.class && (
              <div className="flex items-start gap-4">
                <BookUser className="w-5 h-5 mt-1 text-muted-foreground flex-shrink-0" />
                <div>
                  <h3 className="font-semibold">Classe</h3>
                  <p className="text-muted-foreground text-sm mt-1">{user.class}</p>
                </div>
              </div>
            )}

            {user.phone && (
              <div className="flex items-start gap-4">
                <Phone className="w-5 h-5 mt-1 text-muted-foreground flex-shrink-0" />
                <div>
                  <h3 className="font-semibold">Téléphone</h3>
                  <p className="text-muted-foreground text-sm mt-1">+225 {user.phone}</p>
                </div>
              </div>
            )}
            
            {!user.online && user.lastSeen && (
                 <div className="flex items-start gap-4">
                    <Clock className="w-5 h-5 mt-1 text-muted-foreground flex-shrink-0" />
                    <div>
                        <h3 className="font-semibold">Dernière connexion</h3>
                        <p className="text-muted-foreground text-sm mt-1">
                            Vu {formatLastSeen(user.lastSeen)}
                        </p>
                    </div>
                </div>
            )}

          </div>
        </div>
      </main>
      
      <Sheet open={isSheetOpen} onOpenChange={setIsSheetOpen}>
        <SheetContent className='flex flex-col'>
          <SheetHeader>
            <SheetTitle>Modifier le profil</SheetTitle>
            <SheetDescription>
              Mettez à jour vos informations personnelles.
            </SheetDescription>
          </SheetHeader>
          <form onSubmit={handleSave} className="flex-1 space-y-6 py-6 overflow-auto px-1">
            <div className="space-y-2">
              <Label htmlFor="name">Nom complet</Label>
              <Input id="name" value={editedUser.name || ''} onChange={handleInputChange} placeholder="Ex: John Doe" />
            </div>
            <div className="space-y-2">
              <Label htmlFor="bio">Biographie</Label>
              <textarea id="bio" value={editedUser.bio || ''} onChange={handleInputChange} placeholder="Parlez un peu de vous..." className="w-full min-h-[100px] bg-transparent border border-input rounded-md p-2 text-sm" />
            </div>
            <div className="space-y-2">
                <Label htmlFor="phone">Téléphone</Label>
                 <div className="relative">
                    <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none gap-2">
                        <Image src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fe/Flag_of_C%C3%B4te_d%27Ivoire.svg/langfr-250px-Flag_of_C%C3%B4te_d%27Ivoire.svg.png" width={20} height={15} alt="Drapeau de la Côte d'Ivoire"/>
                        <span className="text-muted-foreground">+225</span>
                    </div>
                    <Input id="phone" type="tel" value={editedUser.phone || ''} onChange={handleInputChange} placeholder="01 23 45 67 89" className="pl-24" />
                  </div>
            </div>
            <div className="space-y-2">
                <Label htmlFor="class">Classe</Label>
                <Select onValueChange={handleClassChange} value={editedUser.class || ''}>
                  <SelectTrigger>
                    <SelectValue placeholder="Sélectionner une classe" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="1ère A1">1ère A1</SelectItem>
                    <SelectItem value="1ère A22">1ère A22</SelectItem>
                    <SelectItem value="2nde A22">2nde A22</SelectItem>
                  </SelectContent>
                </Select>
            </div>
          </form>
          <SheetFooter>
            <Button variant="outline" onClick={() => setIsSheetOpen(false)}>Annuler</Button>
            <Button type="submit" onClick={handleSave} disabled={loading}>
              {loading ? <Loader2 className="animate-spin mr-2" /> : null}
              Enregistrer
            </Button>
          </SheetFooter>
        </SheetContent>
      </Sheet>
    </div>
  );
}
